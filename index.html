<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisaPredict AI - Predictor de Aprobación de Visas</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes progressBar { from { width: 0%; } to { width: 100%; } }
        .progress-bar { animation: progressBar 5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes countUp { from { transform: scale(1.5); } to { transform: scale(1); } }
        .count-animation { animation: countUp 0.3s ease-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); } 20%, 40%, 60%, 80% { transform: translateX(2px); } }
        .shake { animation: shake 0.5s ease-in-out; }
        
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75); display: flex;
            align-items: center; justify-content: center; z-index: 9999;
        }
        
        /* === ESTILOS DE TEMA (Sin cambios) === */
        .dark-theme { background-color: #0f172a; color: #e2e8f0; }
        .dark-theme .bg-white { background-color: #1e293b !important; color: #e2e8f0; }
        .dark-theme .bg-gray-50 { background-color: #0f172a !important; }
        .dark-theme .bg-gray-100 { background-color: #1e293b !important; }
        .dark-theme .bg-gray-50:not(.bg-green-50):not(.bg-red-50):not(.bg-yellow-50) { background-color: #334155 !important; }
        .dark-theme .text-gray-700 { color: #cbd5e0 !important; }
        .dark-theme .text-gray-600 { color: #a0aec0 !important; }
        .dark-theme .text-gray-500 { color: #94a3b8 !important; }
        .dark-theme .text-gray-900 { color: #f1f5f9 !important; }
        .dark-theme .text-blue-900 { color: #60a5fa !important; }
        .dark-theme .border-gray-200 { border-color: #334155 !important; }
        .dark-theme .border-gray-300 { border-color: #475569 !important; }
        .dark-theme .bg-blue-50 { background-color: #1e3a8a !important; color: #bfdbfe !important; }
        .dark-theme .bg-red-50 { background-color: #7f1d1d !important; color: #fecaca !important; }
        .dark-theme .bg-green-50 { background-color: #14532d !important; color: #bbf7d0 !important; }
        .dark-theme .bg-yellow-50 { background-color: #713f12 !important; color: #fef3c7 !important; }
        .dark-theme .text-green-700 { color: #86efac !important; }
        .dark-theme .text-red-700 { color: #fca5a5 !important; }
        .dark-theme .text-yellow-800 { color: #fde047 !important; }
        .dark-theme .text-green-800 { color: #86efac !important; }
        .dark-theme .text-red-800 { color: #fca5a5 !important; }
        .dark-theme .bg-green-100 { background-color: #166534 !important; color: #bbf7d0 !important; }
        .dark-theme .bg-red-100 { background-color: #991b1b !important; color: #fecaca !important; }
        .dark-theme .border-green-500 { border-color: #22c55e !important; }
        .dark-theme .border-red-500 { border-color: #ef4444 !important; }
        .dark-theme .border-yellow-300 { border-color: #fbbf24 !important; }
        .dark-theme .bg-gray-200 { background-color: #475569 !important; }
        .dark-theme input, .dark-theme select { background-color: #334155 !important; color: #f1f5f9 !important; border-color: #475569 !important; }
        .dark-theme input:focus, .dark-theme select:focus { border-color: #60a5fa !important; outline: none !important; box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1) !important; }
        .dark-theme .modal-backdrop { background-color: rgba(0, 0, 0, 0.9); }
        .dark-theme .bg-gray-800 { background-color: #1f2937 !important; }
        .dark-theme .hover\\:bg-gray-200:hover { background-color: #374151 !important; }
        .dark-theme .hover\\:bg-blue-50:hover { background-color: #1e3a8a !important; }
        
        .blue-theme { background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%); min-height: 100vh; }
        .blue-theme .bg-gray-50 { background-color: transparent !important; }
        .blue-theme .bg-gray-100 { background-color: #bfdbfe !important; }
        .blue-theme .bg-white { background-color: #f0f9ff !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .blue-theme .border-gray-200 { border-color: #93c5fd !important; }
        .blue-theme .bg-gray-200 { background-color: #dbeafe !important; }
        .blue-theme .bg-gray-50:not(.bg-green-50):not(.bg-red-50):not(.bg-yellow-50) { background-color: #e0f2fe !important; }
        
        .theme-switch { transition: all 0.3s ease; }
        
        /* === ESTILOS DE CONTROLES (Sin cambios) === */
        .control-buttons-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.08); padding: 8px; border-radius: 9999px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); display: flex; gap: 8px; transition: all 0.3s ease;
        }
        .control-button {
            background-color: transparent; border: none; padding: 8px 12px; border-radius: 9999px;
            display: flex; align-items: center; gap: 6px; transition: all 0.3s ease;
            cursor: pointer; color: #374151;
        }
        .control-button:hover { background-color: rgba(0, 0, 0, 0.05); }
        .dark-theme .control-buttons-container { background: rgba(30, 41, 59, 0.8); border-color: rgba(255, 255, 255, 0.1); }
        .dark-theme .control-button { color: #e2e8f0; }
        .dark-theme .control-button:hover { background-color: rgba(255, 255, 255, 0.1); }
        .blue-theme .control-buttons-container { background: rgba(240, 249, 255, 0.8); border-color: rgba(147, 197, 253, 0.5); }
        .blue-theme .control-button { color: #1e3a8a; }
        .blue-theme .control-button:hover { background-color: rgba(191, 219, 254, 0.5); }
        .dark-theme .bg-blue-900 { background-color: #3b82f6 !important; }
        .dark-theme .hover\\:bg-blue-800:hover { background-color: #2563eb !important; }
        .dark-theme .focus\\:ring-blue-900:focus { --tw-ring-color: #3b82f6 !important; }
        .blue-theme .bg-blue-900 { background-color: #1d4ed8 !important; }
        .blue-theme .hover\\:bg-blue-800:hover { background-color: #1e40af !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, Fragment } = React;
        const { Brain, FileText, CheckCircle, XCircle, AlertCircle, Loader2, AlertTriangle, Users, BarChart2, Moon, Sun, Globe, Palette } = lucide;

        // Traducciones (sin cambios)
        const translations = { es: { title: "Predicción Inteligente de Aprobación de Visas de Trabajo en EE.UU.", formTitle: "Ingrese los Datos para Predicción", country: "País de Origen", education: "Nivel Máximo de Estudios Terminado y Comprobable", experience: "¿Tiene Experiencia en un Puesto Similar al que Está Aplicando?", state: "¿En qué Estado de USA es la Posición a la que Aplica?", fullTime: "¿Aplicará para un Empleo de Tiempo Completo?", selectCountry: "Seleccione su país de origen", selectEducation: "Seleccione su nivel de estudios", selectOption: "Seleccione una opción", selectState: "Seleccione el estado", highSchool: "Preparatoria/Secundaria", bachelors: "Licenciatura", masters: "Maestría", doctorate: "Doctorado", yes: "Sí", no: "No", predict: "Obtener Predicción con AI", analyzing: "Analizando...", requiredFields: "* Todos los campos son requeridos", validationTitle1: "Debes completar todos los campos", validationTitle2: "Campos incompletos", validationMsg1: "Para poder estimar un resultado con IA, necesitas completar todos los campos del formulario.", validationMsg2: "Por favor complete los siguientes campos para continuar:", understood: "Entendido", aiValidating: "Nuestro Modelo de Inteligencia Artificial está validando tu caso", analyzingInfo: "Analizando información...", highProb: "Alta probabilidad de aprobación", lowProb: "Baja probabilidad de aprobación", highProbMsg: "Según los datos que proporcionaste, nuestro modelo de inteligencia artificial estima que <strong>tienes una alta probabilidad de obtener la aprobación de tu visa</strong>.", lowProbMsg: "Con base en la información que ingresaste, nuestro modelo de Inteligencia Artificial estima que <strong>la probabilidad de aprobación de tu visa es baja en este momento</strong>.", approvalProb: "Probabilidad de Aprobación", denialProb: "Probabilidad de Denegación", importantNote: "Nota importante:", disclaimer1: "Los resultados presentados por VisaPredict AI son generados mediante un modelo de inteligencia artificial basado en patrones estadísticos y datos históricos. Esta predicción", disclaimer2: "no representa una garantía, consejo legal, ni un veredicto oficial", disclaimer3: "sobre la aprobación o rechazo de una visa.", disclaimer4: "VisaPredict AI", disclaimer5: "no se hace responsable", disclaimer6: "por decisiones tomadas con base en esta información. Se recomienda acudir a fuentes oficiales del gobierno de los Estados Unidos o consultar con especialistas en migración para obtener orientación personalizada.", history: "Historial de Predicciones", approved: "Aprobado", denied: "Denegado", countryLabel: "País:", stateLabel: "Estado:", educationLabel: "Educación:", experienceLabel: "Experiencia:", newPrediction: "Nueva Predicción", predictions: "Predicciones", realizadas: "Realizadas", meetTeam: "Conoce al Spring Team", footerNote: "Nota: Esta es una predicción basada en IA y no garantiza el resultado real del proceso de visa.", agileForce: "✨ Que La Fuerza de La Agilidad te Acompañe ✨", error: "Error al obtener la predicción. Por favor intente nuevamente." }, en: { title: "Intelligent U.S. Work Visa Approval Prediction", formTitle: "Enter Data for Prediction", country: "Country of Origin", education: "Highest Level of Completed and Verifiable Education", experience: "Do You Have Experience in a Similar Position to the One You're Applying For?", state: "In Which U.S. State is the Position You're Applying For?", fullTime: "Will You Apply for a Full-Time Position?", selectCountry: "Select your country of origin", selectEducation: "Select your education level", selectOption: "Select an option", selectState: "Select the state", highSchool: "High School", bachelors: "Bachelor's", masters: "Master's", doctorate: "Doctorate", yes: "Yes", no: "No", predict: "Get AI Prediction", analyzing: "Analyzing...", requiredFields: "* All fields are required", validationTitle1: "You must complete all fields", validationTitle2: "Incomplete fields", validationMsg1: "To get an AI result estimate, you need to complete all form fields.", validationMsg2: "Please complete the following fields to continue:", understood: "Understood", aiValidating: "Our Artificial Intelligence Model is validating your case", analyzingInfo: "Analyzing information...", highProb: "High approval probability", lowProb: "Low approval probability", highProbMsg: "Based on the data you provided, our artificial intelligence model estimates that <strong>you have a high probability of getting your visa approved</strong>.", lowProbMsg: "Based on the information you entered, our Artificial Intelligence model estimates that <strong>the probability of your visa approval is currently low</strong>.", approvalProb: "Approval Probability", denialProb: "Denial Probability", importantNote: "Important note:", disclaimer1: "The results presented by VisaPredict AI are generated by an artificial intelligence model based on statistical patterns and historical data. This prediction", disclaimer2: "does not represent a guarantee, legal advice, or an official verdict", disclaimer3: "on visa approval or rejection.", disclaimer4: "VisaPredict AI", disclaimer5: "is not responsible", disclaimer6: "for decisions made based on this information. We recommend consulting official U.S. government sources or immigration specialists for personalized guidance.", history: "Prediction History", approved: "Approved", denied: "Denied", countryLabel: "Country:", stateLabel: "State:", educationLabel: "Education:", experienceLabel: "Experience:", newPrediction: "New Prediction", predictions: "Predictions", realizadas: "Made", meetTeam: "Meet the Spring Team", footerNote: "Note: This is an AI-based prediction and does not guarantee the actual visa process result.", agileForce: "✨ May The Force of Agility Be With You ✨", error: "Error getting prediction. Please try again." } };
        const firebaseConfig = { apiKey: "TU_API_KEY_AQUI", authDomain: "visapredict-ai.firebaseapp.com", databaseURL: "https://visapredict-ai-default-rtdb.firebaseio.com", projectId: "visapredict-ai", storageBucket: "visapredict-ai.appspot.com", messagingSenderId: "TU_SENDER_ID_AQUI", appId: "TU_APP_ID_AQUI" };
        
        // --- INICIO DE LA CORRECCIÓN ---

        // Función para aplicar clases al body. La mantenemos fuera para claridad.
        const applyThemeToBody = (theme) => {
            document.body.classList.remove('dark-theme', 'blue-theme');
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else if (theme === 'blue') {
                document.body.classList.add('blue-theme');
            }
        };

        // Componente Principal que maneja el estado del tema y el idioma
        function App() {
            // El estado ahora vive en este componente "padre"
            const [theme, setTheme] = useState(() => window.localStorage.getItem('visapredict-theme') || 'light');
            const [language, setLanguage] = useState(() => window.localStorage.getItem('visapredict-language') || 'es');
            
            // Efecto para guardar las preferencias cuando cambian
            useEffect(() => {
                window.localStorage.setItem('visapredict-theme', theme);
                window.localStorage.setItem('visapredict-language', language);
                applyThemeToBody(theme); // Aplicamos la clase al body
            }, [theme, language]);

            return (
                <VisaPredictAI
                    key={theme + language} // LA CLAVE: ¡Esto fuerza el re-montaje completo!
                    initialTheme={theme}
                    initialLanguage={language}
                    setTheme={setTheme}
                    setLanguage={setLanguage}
                />
            );
        }

        // El componente de la UI ahora recibe su estado inicial como props
        function VisaPredictAI({ initialTheme, initialLanguage, setTheme, setLanguage }) {
            
            const [formData, setFormData] = useState({ country: '', education_of_employee: '', has_job_experience: '', state: '', full_time_position: '' });
            const [loading, setLoading] = useState(false);
            const [predictionResult, setPredictionResult] = useState(null);
            const [error, setError] = useState(null);
            const [predictions, setPredictions] = useState([]);
            const [totalPredictions, setTotalPredictions] = useState(0);
            const [showValidationModal, setShowValidationModal] = useState(false);
            const [missingFieldsList, setMissingFieldsList] = useState([]);
            
            // Usamos el estado inicial que nos pasaron
            const language = initialLanguage;
            const theme = initialTheme;
            const t = translations[language];

            // Este efecto ahora solo se preocupa de los íconos y el contador,
            // ya que el tema se aplica al montar.
            useEffect(() => {
                // Renderizar los íconos de Lucide
                lucide.createIcons();

                // Inicializar Firebase si no está ya inicializado
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const database = firebase.database();
                const counterRef = database.ref('totalPredictions');
                counterRef.on('value', (snapshot) => {
                    const count = snapshot.val() || 0;
                    setTotalPredictions(count);
                });
                
                return () => counterRef.off();
            }, []); // Se ejecuta solo una vez por montaje

            // Funciones para cambiar tema/idioma ahora llaman al 'setter' del padre
            const toggleLanguage = () => {
                setLanguage(language === 'es' ? 'en' : 'es');
            };
            
            const cycleTheme = () => {
                const newTheme = theme === 'light' ? 'dark' : theme === 'dark' ? 'blue' : 'light';
                setTheme(newTheme);
            };

        // --- FIN DE LA CORRECCIÓN ---

            // Mapeos y lógica del formulario (sin cambios)
            const countryToContinent = { 'Algeria': 'Africa', 'Angola': 'Africa', 'Benin': 'Africa', 'Botswana': 'Africa', 'Burkina Faso': 'Africa', 'Burundi': 'Africa', 'Cameroon': 'Africa', 'Cape Verde': 'Africa', 'Central African Republic': 'Africa', 'Chad': 'Africa', 'Comoros': 'Africa', 'Congo': 'Africa', 'DR Congo': 'Africa', 'Djibouti': 'Africa', 'Egypt': 'Africa', 'Equatorial Guinea': 'Africa', 'Eritrea': 'Africa', 'Ethiopia': 'Africa', 'Gabon': 'Africa', 'Gambia': 'Africa', 'Ghana': 'Africa', 'Guinea': 'Africa', 'Guinea-Bissau': 'Africa', 'Ivory Coast': 'Africa', 'Kenya': 'Africa', 'Lesotho': 'Africa', 'Liberia': 'Africa', 'Libya': 'Africa', 'Madagascar': 'Africa', 'Malawi': 'Africa', 'Mali': 'Africa', 'Mauritania': 'Africa', 'Mauritius': 'Africa', 'Morocco': 'Africa', 'Mozambique': 'Africa', 'Namibia': 'Africa', 'Niger': 'Africa', 'Nigeria': 'Africa', 'Rwanda': 'Africa', 'Sao Tome': 'Africa', 'Senegal': 'Africa', 'Seychelles': 'Africa', 'Sierra Leone': 'Africa', 'Somalia': 'Africa', 'South Africa': 'Africa', 'South Sudan': 'Africa', 'Sudan': 'Africa', 'Swaziland': 'Africa', 'Tanzania': 'Africa', 'Togo': 'Africa', 'Tunisia': 'Africa', 'Uganda': 'Africa', 'Zambia': 'Africa', 'Zimbabwe': 'Africa', 'Afghanistan': 'Asia', 'Armenia': 'Asia', 'Azerbaijan': 'Asia', 'Bahrain': 'Asia', 'Bangladesh': 'Asia', 'Bhutan': 'Asia', 'Brunei': 'Asia', 'Cambodia': 'Asia', 'China': 'Asia', 'Cyprus': 'Asia', 'Georgia': 'Asia', 'India': 'Asia', 'Indonesia': 'Asia', 'Iran': 'Asia', 'Iraq': 'Asia', 'Israel': 'Asia', 'Japan': 'Asia', 'Jordan': 'Asia', 'Kazakhstan': 'Asia', 'Kuwait': 'Asia', 'Kyrgyzstan': 'Asia', 'Laos': 'Asia', 'Lebanon': 'Asia', 'Malaysia': 'Asia', 'Maldives': 'Asia', 'Mongolia': 'Asia', 'Myanmar': 'Asia', 'Nepal': 'Asia', 'North Korea': 'Asia', 'Oman': 'Asia', 'Pakistan': 'Asia', 'Palestine': 'Asia', 'Philippines': 'Asia', 'Qatar': 'Asia', 'Russia': 'Asia', 'Saudi Arabia': 'Asia', 'Singapore': 'Asia', 'South Korea': 'Asia', 'Sri Lanka': 'Asia', 'Syria': 'Asia', 'Taiwan': 'Asia', 'Tajikistan': 'Asia', 'Thailand': 'Asia', 'Timor-Leste': 'Asia', 'Turkey': 'Asia', 'Turkmenistan': 'Asia', 'UAE': 'Asia', 'Uzbekistan': 'Asia', 'Vietnam': 'Asia', 'Yemen': 'Asia', 'Albania': 'Europe', 'Andorra': 'Europe', 'Austria': 'Europe', 'Belarus': 'Europe', 'Belgium': 'Europe', 'Bosnia': 'Europe', 'Bulgaria': 'Europe', 'Croatia': 'Europe', 'Czech Republic': 'Europe', 'Denmark': 'Europe', 'Estonia': 'Europe', 'Finland': 'Europe', 'France': 'Europe', 'Germany': 'Europe', 'Greece': 'Europe', 'Hungary': 'Europe', 'Iceland': 'Europe', 'Ireland': 'Europe', 'Italy': 'Europe', 'Kosovo': 'Europe', 'Latvia': 'Europe', 'Liechtenstein': 'Europe', 'Lithuania': 'Europe', 'Luxembourg': 'Europe', 'Macedonia': 'Europe', 'Malta': 'Europe', 'Moldova': 'Europe', 'Monaco': 'Europe', 'Montenegro': 'Europe', 'Netherlands': 'Europe', 'Norway': 'Europe', 'Poland': 'Europe', 'Portugal': 'Europe', 'Romania': 'Europe', 'San Marino': 'Europe', 'Serbia': 'Europe', 'Slovakia': 'Europe', 'Slovenia': 'Europe', 'Spain': 'Europe', 'Sweden': 'Europe', 'Switzerland': 'Europe', 'Ukraine': 'Europe', 'United Kingdom': 'Europe', 'Vatican': 'Europe', 'Antigua and Barbuda': 'North America', 'Bahamas': 'North America', 'Barbados': 'North America', 'Belize': 'North America', 'Canada': 'North America', 'Costa Rica': 'North America', 'Cuba': 'North America', 'Dominica': 'North America', 'Dominican Republic': 'North America', 'El Salvador': 'North America', 'Grenada': 'North America', 'Guatemala': 'North America', 'Haiti': 'North America', 'Honduras': 'North America', 'Jamaica': 'North America', 'Mexico': 'North America', 'Nicaragua': 'North America', 'Panama': 'North America', 'Saint Kitts': 'North America', 'Saint Lucia': 'North America', 'Saint Vincent': 'North America', 'Trinidad and Tobago': 'North America', 'United States': 'North America', 'Argentina': 'South America', 'Bolivia': 'South America', 'Brazil': 'South America', 'Chile': 'South America', 'Colombia': 'South America', 'Ecuador': 'South America', 'Guyana': 'South America', 'Paraguay': 'South America', 'Peru': 'South America', 'Suriname': 'South America', 'Uruguay': 'South America', 'Venezuela': 'South America', 'Australia': 'Oceania', 'Fiji': 'Oceania', 'Kiribati': 'Oceania', 'Marshall Islands': 'Oceania', 'Micronesia': 'Oceania', 'Nauru': 'Oceania', 'New Zealand': 'Oceania', 'Palau': 'Oceania', 'Papua New Guinea': 'Oceania', 'Samoa': 'Oceania', 'Solomon Islands': 'Oceania', 'Tonga': 'Oceania', 'Tuvalu': 'Oceania', 'Vanuatu': 'Oceania' };
            const stateToRegion = { 'Alaska': 'West', 'Arizona': 'West', 'California': 'West', 'Colorado': 'West', 'Hawaii': 'West', 'Idaho': 'West', 'Montana': 'West', 'Nevada': 'West', 'New Mexico': 'West', 'Oregon': 'West', 'Utah': 'West', 'Washington': 'West', 'Wyoming': 'West', 'Connecticut': 'Northeast', 'Maine': 'Northeast', 'Massachusetts': 'Northeast', 'New Hampshire': 'Northeast', 'New Jersey': 'Northeast', 'New York': 'Northeast', 'Pennsylvania': 'Northeast', 'Rhode Island': 'Northeast', 'Vermont': 'Northeast', 'Alabama': 'South', 'Arkansas': 'South', 'Delaware': 'South', 'District of Columbia': 'South', 'Florida': 'South', 'Georgia': 'South', 'Kentucky': 'South', 'Louisiana': 'South', 'Maryland': 'South', 'Mississippi': 'South', 'North Carolina': 'South', 'Oklahoma': 'South', 'South Carolina': 'South', 'Tennessee': 'South', 'Texas': 'South', 'Virginia': 'South', 'West Virginia': 'South', 'Illinois': 'Midwest', 'Indiana': 'Midwest', 'Iowa': 'Midwest', 'Kansas': 'Midwest', 'Michigan': 'Midwest', 'Minnesota': 'Midwest', 'Missouri': 'Midwest', 'Nebraska': 'Midwest', 'North Dakota': 'Midwest', 'Ohio': 'Midwest', 'South Dakota': 'Midwest', 'Wisconsin': 'Midwest' };
            const handleInputChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); setPredictionResult(null); setError(null); };
            const validateForm = () => { const fields = { country: t.country, education_of_employee: t.education, has_job_experience: t.experience, state: t.state, full_time_position: t.fullTime }; const missingFields = []; Object.keys(fields).forEach(field => { if (!formData[field]) { missingFields.push(fields[field]); } }); return missingFields; };
            const incrementFirebaseCounter = async () => { try { const counterRef = firebase.database().ref('totalPredictions'); await counterRef.transaction((currentValue) => (currentValue || 0) + 1); } catch (error) { console.error('Error al actualizar contador en Firebase:', error); } };
            const submitPrediction = async () => { const missingFields = validateForm(); if (missingFields.length > 0) { setMissingFieldsList(missingFields); setShowValidationModal(true); return; } setLoading(true); setError(null); setPredictionResult(null); const continent = countryToContinent[formData.country] || 'Unknown'; const region = stateToRegion[formData.state] || 'Unknown'; const dataToSend = { full_time_position: formData.full_time_position, region_of_employment: region, continent: continent, has_job_experience: formData.has_job_experience, education_of_employee: formData.education_of_employee }; const minLoadTime = 5000; const startTime = Date.now(); try { const response = await fetch('https://visa-prediction-app-390129724119.us-central1.run.app/visa_prediction', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dataToSend) }); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); const result = await response.json(); const elapsedTime = Date.now() - startTime; const remainingTime = Math.max(0, minLoadTime - elapsedTime); await new Promise(resolve => setTimeout(resolve, remainingTime)); const [status, [[probYes, probNo]]] = result; setPredictionResult({ status: status, probYes: (probYes * 100).toFixed(1), probNo: (probNo * 100).toFixed(1) }); setPredictions(prev => [...prev, { data: { ...formData, continent, region }, result: { status: status, probYes: (probYes * 100).toFixed(1), probNo: (probNo * 100).toFixed(1) }, timestamp: new Date().toLocaleString() }]); await incrementFirebaseCounter(); } catch (err) { console.error('Error:', err); setError(t.error); } finally { setLoading(false); } };
            const resetForm = () => { setFormData({ country: '', education_of_employee: '', has_job_experience: '', state: '', full_time_position: '' }); setPredictionResult(null); setError(null); };

            return (
                <Fragment>
                    {showValidationModal && ( <div className="modal-backdrop"><div className="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4 fade-in"><div className="text-center"><div className="mb-6"><i data-lucide="alert-triangle" className="h-16 w-16 text-yellow-600 mx-auto shake"></i></div><h3 className="text-xl font-semibold text-gray-900 mb-4">{missingFieldsList.length === 5 ? t.validationTitle1 : t.validationTitle2}</h3><p className="text-gray-600 mb-6">{missingFieldsList.length === 5 ? t.validationMsg1 : t.validationMsg2}</p>{missingFieldsList.length < 5 && (<div className="bg-yellow-50 rounded-lg p-4 mb-6 text-left"><ul className="space-y-2">{missingFieldsList.map((field, index) => (<li key={index} className="flex items-center space-x-2"><span className="text-yellow-600 font-bold">•</span><span className="text-gray-700">{field}</span></li>))}</ul></div>)}<button onClick={() => setShowValidationModal(false)} className="bg-blue-900 text-white py-2 px-6 rounded-lg font-medium hover:bg-blue-800 transition-colors duration-200">{t.understood}</button></div></div></div> )}
                    {loading && ( <div className="modal-backdrop"><div className="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4 fade-in"><div className="text-center"><div className="mb-6"><i data-lucide="brain" className="h-16 w-16 text-blue-900 mx-auto animate-pulse"></i></div><h3 className="text-xl font-semibold text-gray-900 mb-4">{t.aiValidating}</h3><div className="relative pt-1"><div className="overflow-hidden h-4 mb-4 text-xs flex rounded-full bg-gray-200"><div className="progress-bar shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-900"></div></div></div><p className="text-sm text-gray-600 animate-pulse">{t.analyzingInfo}</p></div></div></div> )}
                    <header className="bg-white border-b border-gray-200 shadow-sm"><div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6"><div className="flex items-center justify-center"><div className="flex items-center space-x-3"><img src="LogoVisaPredictAI.png" alt="VisaPredict AI Logo" className="h-16 w-16 object-contain"/>< div><h1 className="text-2xl font-bold text-blue-900">VisaPredict <span className="text-red-600">AI</span></h1><p className="text-sm text-gray-700">{t.title}</p></div></div></div></div></header>
                    <div className="control-buttons-container">
                        <button onClick={toggleLanguage} className="control-button" title={language === 'es' ? 'Switch to English' : 'Cambiar a Español'}><i data-lucide="globe" className="h-4 w-4"></i><span className="text-sm font-medium">{language === 'es' ? 'EN' : 'ES'}</span></button>
                        <button onClick={cycleTheme} className="control-button" title={theme === 'light' ? 'Modo oscuro' : theme === 'dark' ? 'Modo azul' : 'Modo claro'}>
                            {theme === 'light' && <i data-lucide="moon" className="h-4 w-4"></i>}
                            {theme === 'dark' && <i data-lucide="palette" className="h-4 w-4"></i>}
                            {theme === 'blue' && <i data-lucide="sun" className="h-4 w-4"></i>}
                        </button>
                    </div>
                    <main className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                        <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
                            <h2 className="text-xl font-semibold text-blue-900 mb-6">{t.formTitle}</h2>
                            <div className="space-y-6">
                                <div><label className="block text-sm font-medium text-gray-700 mb-2">{t.country} *</label><select name="country" value={formData.country} onChange={handleInputChange} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"><option value="">{t.selectCountry}</option>{Object.keys(countryToContinent).sort().map(country => (<option key={country} value={country}>{country}</option>))}</select></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-2">{t.education} *</label><select name="education_of_employee" value={formData.education_of_employee} onChange={handleInputChange} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"><option value="">{t.selectEducation}</option><option value="High School">{t.highSchool}</option><option value="Bachelor's">{t.bachelors}</option><option value="Master's">{t.masters}</option><option value="Doctorate">{t.doctorate}</option></select></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-2">{t.experience} *</label><select name="has_job_experience" value={formData.has_job_experience} onChange={handleInputChange} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"><option value="">{t.selectOption}</option><option value="Y">{t.yes}</option><option value="N">{t.no}</option></select></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-2">{t.state} *</label><select name="state" value={formData.state} onChange={handleInputChange} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"><option value="">{t.selectState}</option>{Object.keys(stateToRegion).sort().map(state => (<option key={state} value={state}>{state}</option>))}</select></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-2">{t.fullTime} *</label><select name="full_time_position" value={formData.full_time_position} onChange={handleInputChange} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"><option value="">{t.selectOption}</option><option value="Y">{t.yes}</option><option value="N">{t.no}</option></select></div>
                                <div className="pt-6"><button onClick={submitPrediction} disabled={loading} className="w-full bg-blue-900 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-800 transition-colors duration-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">{loading ? (<><i data-lucide="loader-2" className="h-5 w-5 animate-spin"></i><span>{t.analyzing}</span></>) : (<><i data-lucide="brain" className="h-5 w-5"></i><span>{t.predict}</span></>)}</button></div>
                                {error && (<div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center space-x-2"><i data-lucide="alert-circle" className="h-5 w-5 text-red-600"></i><span className="text-red-700">{error}</span></div>)}
                                {predictionResult && (<div className={`mt-6 p-6 rounded-lg border-2 ${predictionResult.status === 'Certified' ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}`}><div className="flex items-center justify-center space-x-3 mb-4">{predictionResult.status === 'Certified' ? (<><i data-lucide="check-circle" className="h-12 w-12 text-green-600"></i><div className="text-center"><h3 className="text-2xl font-bold text-green-800">{t.highProb}</h3><p className="text-green-700 mt-1" dangerouslySetInnerHTML={{ __html: t.highProbMsg }}></p></div></>) : (<><i data-lucide="x-circle" className="h-12 w-12 text-red-600"></i><div className="text-center"><h3 className="text-2xl font-bold text-red-800">{t.lowProb}</h3><p className="text-red-700 mt-1" dangerouslySetInnerHTML={{ __html: t.lowProbMsg }}></p></div></>)}</div><div className="mt-6 space-y-3"><div><div className="flex justify-between mb-1"><span className="text-sm font-medium text-green-700">{t.approvalProb}</span><span className="text-sm font-bold text-green-700">{predictionResult.probYes}%</span></div><div className="w-full bg-gray-200 rounded-full h-6 overflow-hidden"><div className="bg-green-500 h-6 rounded-full transition-all duration-1000 ease-out flex items-center justify-center text-white text-xs font-semibold" style={{ width: `${predictionResult.probYes}%` }}>{predictionResult.probYes}%</div></div></div><div><div className="flex justify-between mb-1"><span className="text-sm font-medium text-red-700">{t.denialProb}</span><span className="text-sm font-bold text-red-700">{predictionResult.probNo}%</span></div><div className="w-full bg-gray-200 rounded-full h-6 overflow-hidden"><div className="bg-red-500 h-6 rounded-full transition-all duration-1000 ease-out flex items-center justify-center text-white text-xs font-semibold" style={{ width: `${predictionResult.probNo}%` }}>{predictionResult.probNo}%</div></div></div></div><div className="mt-6 p-4 bg-yellow-50 border border-yellow-300 rounded-lg"><div className="flex items-start space-x-2"><span className="text-yellow-800 font-bold">⚠️</span><div className="text-sm text-yellow-800"><p className="font-semibold mb-1">{t.importantNote}</p><p className="mb-2">{t.disclaimer1} <strong>{t.disclaimer2}</strong> {t.disclaimer3}</p><p className="mb-2">{t.disclaimer4} <strong>{t.disclaimer5}</strong> {t.disclaimer6}</p></div></div></div></div>)}
                                <p className="text-xs text-gray-500 text-center">{t.requiredFields}</p>
                            </div>
                        </div>
                        {predictions.length > 0 && (<div className="mt-8 bg-white rounded-lg shadow-sm border border-gray-200 p-8"><h3 className="text-lg font-semibold text-blue-900 mb-4 flex items-center space-x-2"><i data-lucide="file-text" className="h-5 w-5"></i><span>{t.history}</span></h3><div className="space-y-4">{predictions.slice(-5).reverse().map((pred, idx) => (<div key={idx} className="bg-gray-50 rounded-lg p-4 border border-gray-200"><div className="flex justify-between items-center mb-2"><span className="text-sm text-gray-600">{pred.timestamp}</span><span className={`px-3 py-1 rounded-full text-sm font-medium ${pred.result.status === 'Certified' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{pred.result.status === 'Certified' ? t.approved : t.denied} ({pred.result.probYes}%)</span></div><div className="grid grid-cols-2 gap-2 text-sm"><div><span className="font-medium">{t.countryLabel}</span> {pred.data.country}</div><div><span className="font-medium">{t.stateLabel}</span> {pred.data.state}</div><div><span className="font-medium">{t.educationLabel}</span> {pred.data.education_of_employee}</div><div><span className="font-medium">{t.experienceLabel}</span> {pred.data.has_job_experience === 'Y' ? t.yes : t.no}</div></div></div>))}</div><button onClick={resetForm} className="mt-4 w-full bg-white text-blue-900 py-2 px-4 rounded-lg font-medium border border-blue-900 hover:bg-blue-50 transition-colors duration-200">{t.newPrediction}</button></div>)}
                    </main>
                    <footer className="mt-12 py-8 bg-gray-100"><div className="text-center"><p className="text-sm text-gray-500 mb-6">{t.footerNote}</p><div className="flex items-center justify-center space-x-6 mb-6"><div className="inline-flex items-center space-x-2 bg-gray-800 text-white px-6 py-2 rounded-full shadow-md"><i data-lucide="bar-chart-2" className="h-5 w-5"></i><span className="font-semibold"><span key={totalPredictions} className="count-animation">{totalPredictions.toLocaleString()}</span> {t.predictions} {t.realizadas}</span></div><a href="springteam.html" className="inline-flex items-center space-x-2 bg-blue-900 text-white px-6 py-2 rounded-full hover:bg-blue-800 transition-all duration-300 shadow-md"><i data-lucide="users" className="h-5 w-5"></i><span className="font-semibold">{t.meetTeam}</span></a></div><div className="mt-6 pt-6 border-t border-gray-300"><p className="text-lg font-medium text-gray-700 italic">{t.agileForce}</p></div></div></footer>
                </Fragment>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        // Renderizamos el componente padre 'App' que ahora controla todo.
        root.render(<App />);
    </script>
</body>
</html>